name: Build Firmware

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            curl \
            unzip \
            ninja-build

      - name: Download nRF5 SDK 17.1.0
        run: |
          set -euxo pipefail

          if [ ! -d "nrf5_sdk" ]; then
            echo "Downloading nRF5 SDK 17.1.0..."
            curl -L \
              https://github.com/NordicSemiconductor/nRF5_SDK/archive/refs/tags/v17.1.0.zip \
              -o nrf5_sdk.zip

            unzip nrf5_sdk.zip
            mv nRF5_SDK-17.1.0 nrf5_sdk
          fi

          echo "nRF5 SDK contents:"
          ls nrf5_sdk

      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DARM_NONE_EABI_TOOLCHAIN_PATH=/usr \
            -DNRF5_SDK_PATH=${{ github.workspace }}/nrf5_sdk

      - name: Build firmware
        run: |
          cmake --build build -j$(nproc)
